name: Test & Deploy Laravel App

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.gen.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate version
        id: gen
        run: echo "version=1.0.${GITHUB_RUN_NUMBER}" >> $GITHUB_OUTPUT


  test:
    runs-on: ubuntu-latest
    needs: build  # âœ… optionnel, mais logique de dÃ©pendance (build avant test)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PHP 8.3
        run: |
          sudo add-apt-repository ppa:ondrej/php -y
          sudo apt update
          sudo apt install -y php8.3
          php -v   # âœ… vÃ©rifie que PHP est bien installÃ©

      - name: Run Laravel tests
        run: php artisan test


  deploy:
    runs-on: ubuntu-latest
    needs: [build, test]
    if: ${{ needs.test.result == 'success' }}   # âœ… placÃ© ici, pas au niveau du step

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Deploy version
        run: echo "ğŸš€ DÃ©ploiement de la version ${{ needs.build.outputs.version }}"


  notify:
    runs-on: ubuntu-latest
    needs: [test]
    if: ${{ needs.test.result == 'failure' }}   # âœ… entre guillemets

    steps:
      - name: Notification dâ€™Ã©chec
        run: echo "ğŸš¨ Le dÃ©ploiement a Ã©chouÃ© car les tests n'ont pas passÃ© avec succÃ¨s."
